<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<link rel="stylesheet" th:href="@{/css/chatting.css}" />
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
	<div class="container">
		<div class="EnterOut_div">
			<input type="text" id="user" class="form-control" placeholder="ìœ ì €ëª…">
			<button type="button" class="btn btn-default enter_Btn"
				id="btnConnect">ì—°ê²°</button>
			<button type="button" class="btn btn-default out_Btn"
				id="btnDisconnect" disabled>ì¢…ë£Œ</button>
		</div>
		<div id="chat"></div>
			<div class="input_Btn input_wrap">
				<input type="text" name="msg" id="msg" placeholder="ëŒ€í™” ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."
					class="form-control" disabled>
				<button class="btn_send">ì „ì†¡</button>
			</div>
	</div>
	<script>
		var ws;
		//ì›¹ì†Œì¼“ ë³€ìˆ˜ ì„ ì–¸
		
		$('#btnConnect').click(function() {
		//ì—°ê²°ë²„íŠ¼ í´ë¦­ì‹œ --> function

			if ($('#user').val().trim() != '') {
			// ìœ ì €ëª… í™•ì¸ -> ê³µë°±ì´ ìˆë‹¤ë©´ ì œê±°
				
				ws = new WebSocket("ws://" + location.host + "/chatserver");
				// ì—°ê²°
				// ì†Œì¼“ ì´ë²¤íŠ¸ ë§¤í•‘ --> í¬íŠ¸ë²ˆí˜¸ê¹Œì§€ 
				//ë§Œì•½ ì£¼ì†Œê°€, http://localhost:9090/chatserver ì´ë¼ë©´ --> location.host =  localhost:9090
				
				ws.onopen = function(evt) { 
					//onopení•¸ë“¤ëŸ¬
					
					ws.send('1#' + $('#user').val() + '#');
					// í˜„ì¬ ì‚¬ìš©ì(ë‚˜)ê°€ ì…ì¥í–ˆë‹¤ê³  ì„œë²„ì—ê²Œ í†µì§€(ìœ ì €ëª… ì „ë‹¬)
					// ë³¸ì¸ì€ 1# +userë¡œ ì§€ì • -> ì›¹ì†Œì¼“ ì„œë²„ì—ì„œ ìƒëŒ€ë°©ì€ 2#ìœ¼ë¡œ ì§€ì •í–ˆìŒ. 
					// ë”°ë¼ì„œ 1#ì¸ì§€, 2#ì¸ì§€ì— ë”°ë¼, ë‚˜ì™€ ìƒëŒ€ë°©ì˜ ë©”ì‹œì§€ë¥¼ êµ¬ë¶„ê°€ëŠ¥

					$('#user').attr('readonly', true); //ì´ë¯¸ ì ‘ì†í•œ ìœ ì €ëª… ìˆ˜ì • ëª»í•˜ê²Œ ë§‰ê¸°
					$('#btnConnect').attr('disabled', true); //ì—°ê²° ë˜ì—ˆìœ¼ë‹ˆ ì—°ê²° ë²„íŠ¼ ë¹„í™œì„±í™”
					$('#btnDisconnect').attr('disabled', false); //ì¢…ë£Œ ë²„íŠ¼ í™œì„±í™”
					$('#msg').attr('disabled', false); //ë©”ì‹œì§€ ì…ë ¥ í™œì„±í™”
				};

				ws.onmessage = function(evt) {
					//onmessageí•¸ë“¤ëŸ¬ 
					let no = evt.data.substring(0, 1); // ì›¹ì†Œì¼“ì—ì„œëŠ” JSON í˜•ì‹ìœ¼ë¡œ í†µì‹ 
					//evt_data =  MessageEventÂ {isTrusted: true, data: '1#ì‘ì„±ì#', origin: 'ws://localhost:1223', lastEventId: '', source: null,Â â€¦} í˜•íƒœë¡œì˜´'
					//ë”°ë¼ì„œ, 
					let user = evt.data.substring(2, evt.data.length - 1);
					let index = evt.data.indexOf("#", 2);
					let txt = evt.data.substring(index + 1);

					if (no == '1') {
						print(user, txt);
					} else if (no == '2') {
						index = evt.data.indexOf(":", 2);
						user = evt.data.substring(2, index);
						txt = evt.data.substring(index + 1);
						printOther(user, txt);
					}
				};

				ws.onclose = function(evt) {
					console.log('ì†Œì¼“ì´ ë‹«í™ë‹ˆë‹¤.');
				};

				ws.onerror = function(evt) {
					console.log(evt.data);
				};
			} else {
				alert('ìœ ì €ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
				$('#user').focus();
			}
		});

		// ë©”ì„¸ì§€ ì „ì†¡ ë° ì•„ì´ë””
		function print(user, txt) {
			if (txt.trim() =='') {
				// ë©”ì‹œì§€ ë³¸ë¬¸ì´ ë¹ˆ ë¬¸ìì—´ì¸ ê²½ìš° ì•„ë¬´ ê²ƒë„ í•˜ì§€ ì•ŠìŒ
				return;
			}
			let temp = '';
			temp += '<div class="message_container">';
			temp += ' <span style="font-size:12px;color:#777;margin-bottom: 3px;">'
					+ new Date().toLocaleTimeString([], {
						hour : '2-digit',
						minute : '2-digit'
					}) + '</span>';
			temp += '<div class="message_background">';
			temp += '<div class="message">';
			temp += txt;
			temp += '</div>';
			temp += '</div>';
			temp += '</div>';
			$('#chat').append(temp);
		}

		// ë‹¤ë¥¸ client ì ‘ì†		
		var isFirstMessage = {}; // ê° ì‚¬ìš©ìê°€ ì²˜ìŒìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ëƒˆëŠ”ì§€ ì €ì¥í•˜ëŠ” ê°ì²´
		function printOther(user, txt) {
			if (txt.trim() == '') {
				// ë©”ì‹œì§€ ë³¸ë¬¸ì´ ë¹ˆ ë¬¸ìì—´ì¸ ê²½ìš° ì•„ë¬´ ê²ƒë„ í•˜ì§€ ì•ŠìŒ
				return;
			}
			let temp = '';
			if (!isFirstMessage[user]) { // ì‚¬ìš©ìê°€ ì²˜ìŒìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ëƒˆì„ ë•Œë§Œ ì…ì¥ ë©”ì‹œì§€ë¥¼ ì¶œë ¥
				temp += '<div class="coming_user">';
				temp += "'" + user + "' ì´(ê°€) ì ‘ì†í–ˆìŠµë‹ˆë‹¤.";
				temp += '</div>';
				isFirstMessage[user] = true;
			}
			temp += '<div class="yourChat_message">';
			temp += 'ğŸŸ' + user;
			temp += '<div class="your_message_background">';
			temp += '<div class="your_message">' + txt + '</div>';
			temp += ' <span style="font-size:12px;color:#777;margin-bottom: 3px;">'
					+ new Date().toLocaleTimeString([], {
						hour : '2-digit',
						minute : '2-digit'
					}) + '</span>';
			temp += '</div>';
			temp += '</div>';

			$('#chat').append(temp);
		}

		$('#user').keydown(function() {
			if (event.keyCode == 13) {
				$('#btnConnect').click();
			}
		});

		$(".btn_send").on("click", function() {
			let _msg =  $("#msg").val();
			//ì„œë²„ì—ê²Œ ë©”ì‹œì§€ ì „ë‹¬
			//2#ìœ ì €ëª…#ë©”ì‹œì§€
			ws.send('2#' + $('#user').val() + '#' + _msg); //ì„œë²„ì—ê²Œ
			print($('#user').val(), _msg); //ë³¸ì¸ ëŒ€í™”ì°½ì—

			$('#msg').val('');
			$('#msg').focus();
		});
		
		$('#msg').keydown(function() {
			if (event.keyCode == 13) {
				//ì„œë²„ì—ê²Œ ë©”ì‹œì§€ ì „ë‹¬
				//2#ìœ ì €ëª…#ë©”ì‹œì§€
				ws.send('2#' + $('#user').val() + '#' + $(this).val()); //ì„œë²„ì—ê²Œ
				print($('#user').val(), $(this).val()); //ë³¸ì¸ ëŒ€í™”ì°½ì—

				$('#msg').val('');
				$('#msg').focus();
			}
		});

		$('#btnDisconnect').click(function() {
			ws.close();

			$('#user').attr('readonly', false);
			$('#user').val('');

			$('#btnConnect').attr('disabled', false);
			$('#btnDisconnect').attr('disabled', true);

			$('#msg').val('');
			$('#msg').attr('disabled', true);
		});
		
		function rand(min, max) {
			return Math.floor(Math.random() * (max - min + 1)) + min;
		}

		$(function() {
			$("#chat").css({"background-image": `url("../images/chat_bg${rand(1,15)}.jpg")`});
		});
	</script>
</body>
</html>